name: 'Collect Memory Footprint metrics (Upstream)'
on:
  schedule:
    - cron: '30 2 * * *' # daily @ 02:30 UTC
  workflow_dispatch:
    inputs:
      rrr_check_new:
        description: "Check against the 'done' RRR for new changes."
        required: false
        type: boolean
        default: true
      rrr_save_done:
        description: "Update the 'done' RRR on success."
        required: false
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  KPI_TARGET_BRANCH_NAME: main
  KPI_TARGET_BRANCH_PATCH: main-intel
  RRR_CHECK_NEW: ${{ true }} && ${{ inputs.rrr_check_new }}
  RRR_SAVE_DONE: ${{ true }} && ${{ inputs.rrr_save_done }}
  RRR_NAME_DONE: refpoint_v2-upstream-footprint

jobs:

  # TODO: make a custom action and run it as a step
  get_rrr:
    name: '[Footprint] Get RRR'
    container:
      image: amr-registry.caas.intel.com/zephyrproject/ci-sdk:v0.26.14.1
    defaults:
      run:
        shell: bash
    runs-on: fmos-guest-ubuntu-12c
    outputs:
      rrr-sha: ${{ steps.read-rrr.outputs.rrr-sha }}
      rrr-raw: ${{ steps.read-rrr.outputs.rrr-raw }}
      done-sha: ${{ steps.read-rrr-done.outputs.rrr-sha }}
    env:
      OUR_REPO: ${{ github.repository }}
      REF_WORKFLOW: intel_qa_upstream_refpoint.yml
      REF_BRANCH: main-intel
      ARTIFACT_DIR: ./_artifacts
      ARTIFACT_NAME: refpoint_v2-upstream
    steps:
      - name: Clean Workspace
        run: |
          # set dotglob so rm will remove dot files and dirs - (.west, etc.)
          shopt -s dotglob
          pwd
          if [ -d $ARTIFACT_DIR ]; then
            rm -rv $ARTIFACT_DIR
          fi

      - name: Read the last refpoint
        id: read-rrr
        env:
          GH_TOKEN: ${{ secrets.ZEPHYR_TOKEN }}
        run: |
          # --event schedule
          REF_LAST_RUN=$(gh run list --repo $OUR_REPO --workflow $REF_WORKFLOW --branch $REF_BRANCH --status success --limit 1 --json databaseId --jq .[0].databaseId)
          if [ ! -z "$REF_LAST_RUN" ]; then
            echo "last_run=$REF_LAST_RUN"
            LAST_RRR=$(gh run download --repo $OUR_REPO $REF_LAST_RUN --name $ARTIFACT_NAME --dir $ARTIFACT_DIR && jq -r '.[0].headSha' $ARTIFACT_DIR/$ARTIFACT_NAME)
          else
            echo "ERROR: No refpoint found"
            exit 1
          fi
          echo "last_rrr=$LAST_RRR"
          SHA_RE='^[0-9a-fA-F]{40}$'
          if [[ ! $LAST_RRR =~ $SHA_RE ]]; then
             echo "ERROR: Invalid refpoint $LAST_RRR"
             exit 1
          fi
          echo "rrr-sha=$LAST_RRR" >> $GITHUB_OUTPUT
          echo "rrr-raw=$(cat $ARTIFACT_DIR/$ARTIFACT_NAME)" >> $GITHUB_OUTPUT

      - name: Read last RRR done for footprints
        id: read-rrr-done
        if: env.RRR_CHECK_NEW && steps.read-rrr.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.ZEPHYR_TOKEN }}
        run: |
          set +e
          THIS_WORKFLOW=$(echo "${{ github.workflow_ref }}" | sed -Ee "s|${OUR_REPO}/.github/workflows/(.+)@.*|\1|")
          echo $THIS_WORKFLOW
          # --event schedule
          THIS_LAST_RUN=$(gh run list --repo $OUR_REPO --workflow $THIS_WORKFLOW --branch $REF_BRANCH --status success --limit 1 --json databaseId --jq .[0].databaseId)
          if [ -n "$THIS_LAST_RUN" ]; then
            echo "this_last_run=$THIS_LAST_RUN"
            DONE_RRR=$(gh run download --repo $OUR_REPO $THIS_LAST_RUN --name $RRR_NAME_DONE --dir $ARTIFACT_DIR && jq -r '.[0].headSha' $ARTIFACT_DIR/$RRR_NAME_DONE)
          else
            echo "INFO: No ${THIS_WORKFLOW} executions yet."
            exit 0
          fi
          if [ -z "$DONE_RRR" ]; then
            echo "INFO: No ${THIS_WORKFLOW} completed executions yet."
            exit 0
          fi
          echo "done_rrr=$DONE_RRR"
          SHA_RE='^[0-9a-fA-F]{40}$'
          if [[ ! $DONE_RRR =~ $SHA_RE ]]; then
             echo "ERROR: Invalid done RRR SHA=$DONE_RRR"
             exit 1
          fi
          echo "rrr-sha=$DONE_RRR" >> $GITHUB_OUTPUT
          echo "last_done=$(cat $ARTIFACT_DIR/$RRR_NAME_DONE)"

      - name: Keep the latest RRR done as the most recent artifact
        if: steps.read-rrr-done.outcome == 'success' && steps.read-rrr-done.outputs.rrr-sha
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RRR_NAME_DONE }}
          path: "${{ env.ARTIFACT_DIR }}/${{ env.RRR_NAME_DONE }}"
          retention-days: 7

  run_twister:
    name: "[Footprint] run for '${{ matrix.platform_group }}'"
    needs: [get_rrr]
    if: needs.get_rrr.outputs.rrr-sha != needs.get_rrr.outputs.done-sha
    defaults:
      run:
        shell: bash
    container:
      image: amr-registry.caas.intel.com/zephyrproject/ci-sdk:v0.26.14.1
      options: "-v /srv/runner/workspace:/runner/workspace -v /tmp:/tmp ${{ matrix.container_options }}"
      env:
        TOKEN: ${{ secrets.ZEPHYR_TOKEN }}
    env:
      ZEPHYR_SDK_INSTALL_DIR: /opt/toolchains/zephyr-sdk-0.16.8
    strategy:
      fail-fast: false
      matrix:
        platform_group: [ga, intel, intel_sof, intel_sof_xt]
        include:
          - platform_group: ga
            toolchain: 'zephyr'
            variant: 'zephyr'
            scope: memory_footprint
            platforms: 'acrn, frdm_k64f, it8xxx2_evb, mec172xevb_assy6906, npcx9m6f_evb, up_squared, up_squared_pro_7000'

          - platform_group: intel
            toolchain: 'zephyr'
            variant: 'zephyr'
            scope: memory_footprint
            platforms: 'intel_ehl_crb, intel_ehl_crb/elkhart_lake/sbl, intel_adl_crb, intel_adl_rvp, intel_rpl_p_crb, intel_rpl_s_crb'

          - platform_group: intel_ish
            toolchain: 'zephyr'
            variant: 'zephyr'
            scope: memory_footprint
            platforms: 'intel_ish_5_4_1, intel_ish_5_6_0, intel_ish_5_8_0'

          - platform_group: intel_riscv
            toolchain: 'zephyr'
            variant: 'zephyr'
            scope: memory_footprint
            platforms: 'niosv_m, niosv_g'

          - platform_group: intel_fpga
            toolchain: 'zephyr'
            variant: 'zephyr'
            scope: memory_footprint
            platforms: 'cyclonev_socdk, intel_socfpga_agilex5_socdk, intel_socfpga_agilex_socdk'

          - platform_group: intel_sof
            toolchain: 'zephyr'
            project-filter: '+sof'
            scope: memory_footprint
            platforms: 'intel_adsp/cavs25, intel_adsp/cavs25/tgph'

          - platform_group: intel_sof_xt
            toolchain: 'zephyr'
            variant: 'xt-clang'
            project-filter: '+sof'
            toolchain_ver: 'RI-2022.10-linux'
            xtensa_core: 'ace10_LX7HiFi4_2022_10'
            scope: memory_footprint
            platforms: 'intel_adsp/ace15_mtpm, intel_adsp/ace20_lnl'


    runs-on: fmos-guest-ubuntu-24c
    timeout-minutes: ${{ matrix.timeout || 60 }}
    steps:
      - name: Clean Workspace
        run: |
          # set dotglob so rm will remove dot files and dirs - (.west, etc.)
          shopt -s dotglob
          pwd
          ls -la ./
          rm -rf ./* || true
          rm -rf ./.??* || true
          ls -la ./

      - name: 'Checkout ${{ needs.get_rrr.outputs.rrr-sha }} as ${{ env.KPI_TARGET_BRANCH_NAME }}'
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.get_rrr.outputs.rrr-sha }}
          fetch-depth: 0

      - name: Checkout the triggering branch to main-intel
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: main-intel

      - name: Environment Setup
        shell: bash
        run: |
          touch $HOME/.git-credentials
          touch $HOME/.gitconfig
          git config --global user.email "sys_tmbuild@intel.com"
          git config --global user.name "Github Builder CI"
          git config --global credential.helper 'store --file=$HOME/.git-credentials'

          if [ ! -f "/__w/os.rtos.zephyr.zephyr/.west/config" ]; then
            west init -l . || true
          fi
          if [ ${{ matrix.west_project_filter }} ]; then
            west config manifest.project-filter -- ${{ matrix.west_project_filter }}
          fi
          west config --global update.narrow true
          # west config --global update.path-cache "/runner/workspace"
          # we need this here because our local manifest does import this repo
          echo -e "https://$TOKEN:$TOKEN@github.com/intel-innersource/drivers.audio.firmware.converged" > $HOME/.git-credentials
          west update  2>&1 1> west.update.log || ( rm -rf ../intel ../modules ../bootloader ../tools && west update )
          for r in `west  list -f {url} | grep intel-innersource | sed 's#https://##'`; do
            echo -e "https://$TOKEN:$TOKEN@$r" >> $HOME/.git-credentials
          done
          # debug
          # cat $HOME/.git-credentials
          git config --global --add safe.directory ${PWD}
          west update  2>&1 1>> west.update.log || ( rm -rf ../intel ../modules ../bootloader ../tools && west update )
          west forall -c 'git reset --hard HEAD'

      - name: Patching from main-intel
        if: ${{ env.KPI_TARGET_BRANCH_PATCH }}
        shell: bash
        run: |
          echo "Nothing to patch at the moment."

      - name: Execute Tests
        run: |
          export MEC172X_SPI_GEN=/opt/tools/bin/mec172x_spi_gen_lin_x86_64
          export EVERGLADES_SPI_GEN=/opt/tools/bin/everglades_spi_gen_lin64
          export PATH=/opt/tools/bin:$PATH
          # toolchain
          if [ ${{ matrix.toolchain }} == 'xcc' ]; then
            export ZEPHYR_TOOLCHAIN_VARIANT=${{ matrix.variant }}
            export XTENSA_TOOLCHAIN_PATH=/opt/toolchains/xtensa/XtDevTools/install/tools
            export XTENSA_CORE=${{ matrix.xtensa_core }}
            export TOOLCHAIN_VER=${{ matrix.toolchain_ver }}
            export XTENSA_BUILDS_DIR=/opt/toolchains/xtensa/XtDevTools/install/builds
            export TWISTER_QUARANTINE_LIST=main-intel/.github/data/xcc-twister-quarantine-list.yml
            export XTENSA_SYSTEM=/opt/toolchains/xtensa/XtDevTools/install/tools/${{ matrix.toolchain_ver }}/XtensaTools/config/
          else
            export TWISTER_QUARANTINE_LIST=main-intel/.github/data/twister-quarantine-list.yml
          fi

          TEST_COV="dummy"
          if [ ${{ matrix.scope }} ]; then
            TEST_COV=${{ matrix.scope }}
          fi

          # Ensure local network is not accessed via proxy
          export no_proxy=$no_proxy,192.168.0.0/16

          TEST_PLATFORMS=$(echo "${{ matrix.platforms }}" | sed -e "s/^/,/" -e "s/,/ -p /g")

          if [ -n "$TEST_PLATFORMS" ]; then
            ./scripts/twister -M -x=USE_CCACHE=0 --inline-logs \
              --force-color -v \
              --quarantine-list $TWISTER_QUARANTINE_LIST \
              $TEST_PLATFORMS \
              --test-config main-intel/.github/data/test_config.yaml \
              --level $TEST_COV \
              ${{ matrix.twister_extra_args }} \
              --build-only \
              --footprint-report \
              --enable-size-report
          fi

      - name: Archive twister-out directory
        id: tar-twister-out
        if: (success() || failure() || cancelled())
        run: |
          # Give some time to Twister processes to close logs on cancel.
          [ $(ps -ef | grep twister | wc -l) -ge 2 ] && sleep 60s
          [ -d ./twister-out ] && sync ./twister-out && \
              find ./twister-out -type f -name "*.log" -o -name "*.csv" -o -name "rom.json" -o -name "ram.json" | \
              tar -czf subset-${{ matrix.platform_group }}-twister-out.tar.gz -T -

      - name: Upload twister-out.tar.gz archive per subset
        if: (steps.tar-twister-out.outcome == 'success') && (success() || failure() || cancelled())
        uses: actions/upload-artifact@v3.1.3
        with:
          name: subset-${{ matrix.platform_group }}-twister-out archive in .tar.gz format
          path: |
            subset-${{ matrix.platform_group }}-twister-out.tar.gz
          retention-days: 5

      - name: Upload Unit Test Results
        if: (success() || failure() || cancelled())
        uses: actions/upload-artifact@v3.1.3
        with:
          name: Unit Test Results (Subset ${{ matrix.platform_group }})
          path: |
            twister-out/twister.log
            twister-out/twister.xml
            twister-out/twister.json
            twister-out/twister_footprint.json
          retention-days: 14

  publish-test-results:
    container:
      image: amr-registry.caas.intel.com/zephyrproject/ci-sdk:v0.26.14.1
      env:
        TOKEN: ${{ secrets.ZEPHYR_TOKEN }}
    env:
      ELASTICSEARCH_KEY: ${{ secrets.ELASTICSEARCH_KEY }}
      ELASTICSEARCH_SERVER: 'https://reports-fmos.hf.intel.com:9200'
    name: '[Footprint] Publish Test Results'
    needs: [get_rrr, run_twister]
    runs-on: fmos-guest-ubuntu-12c
    continue-on-error: true
    if: success()
    steps:
      - name: Clean and Pre Environment
        run: |
          rm -rf artifacts
          pip3 install elasticsearch

      - name: Checkout triggering branch
        # Use triggering branch (main-intel) with our upload scripts.
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download Artifacts
        uses: actions/download-artifact@v3.0.2
        with:
          path: artifacts

      - name: Get current date
        id: run_date
        run: |
          echo "run_date=$(date --iso-8601=minutes)" >> "$GITHUB_OUTPUT"
          echo "run_date_short=$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: Upload to ElasticSearch
        id: elk_upload_footprint
        run: |
          echo "${{ steps.run_date.outputs.run_date }} (${{ github.run_id }},${{ github.run_attempt }})"
          echo "head_ref=${{ github.head_ref }} base_ref=${{ github.base_ref }}"
          echo "ref_name=${{ github.ref_name }} ref=${{ github.ref }}"
          python3 scripts/ci/upload_test_results_es.py -r ${{ steps.run_date.outputs.run_date }} \
            --map-file scripts/ci/zephyr_twister_flat_footprint_index.json \
            --flatten footprint \
            --exclude path run_id runnable retries execution_time build_time testcases \
            --flatten-list-names "{'children':'name'}" \
            --transform "{ 'footprint_name': '^(?P<footprint_area>([^\/]+\/){0,2})(?P<footprint_path>([^\/]*\/)*)(?P<footprint_symbol>[^\/]*)$' }" \
            --run-id "${{ github.run_id }}" --run-attempt "${{ github.run_attempt }}" \
            --run-workflow "footprint_metrics:${{ github.event_name }}" --run-branch "${{ env.KPI_TARGET_BRANCH_NAME }}" \
            -i zephyr-tests-footprint-metrics artifacts/**/twister_footprint.json
        #

      - name: Prepare RRR done for save
        if: steps.elk_upload_footprint.outcome == 'success' && env.RRR_SAVE_DONE
        id: save_rrr
        env:
          RRR_RAW: ${{ needs.get_rrr.outputs.rrr-raw }}
        run: |
          echo "$RRR_RAW" > ${{ env.RRR_NAME_DONE }}

      - name: Save RRR done as an artifact
        if: steps.save_rrr.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RRR_NAME_DONE }}
          path: ${{ env.RRR_NAME_DONE }}
          retention-days: 7
