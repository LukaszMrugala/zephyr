name: fmos ssh scp pipeline test
on:
  workflow_dispatch:
    inputs:
      key:
        required: true
jobs:
  fmos-ssh-scp-pipeline-test-connection:
    name: Test connection to static reporting server
    runs-on: guest-hv1-fmos-3
    container:
      image: amr-registry.caas.intel.com/zephyrproject/ci-sdk:v0.26.4.5
      options: "-v /srv/runner/workspace:/runner/workspace"
    env:
      SSH_KEY: ${{ inputs.key }}
      STATICREPORTING_USER: 'zephyr'
      STATICREPORTING_SERVER: 'zep-fmos-static-reporting.igk.intel.com'
      SSH_OPTS: '-o "UserKnownHostsFile=/dev/null" -o "LogLevel ERROR" -o "StrictHostKeyChecking no"'
      PATH_KEY: "$HOME/.ssh/id_rsa-temp"
    defaults:
      run:
        shell: bash
    steps:
      - name: Setup environment
        run: |
          if [ ! -f ${{ env.PATH_KEY }} ]; then
            if [ ! -d "$HOME/.ssh" ]; then
              mkdir -p $HOME/.ssh
            fi
            echo "${{ secrets.IGK_PRIVATE_KEY }}" | tr -d '\r' >> ${{ env.PATH_KEY }}
          fi
          chmod 600 ${{ env.PATH_KEY }}
          ls -la ${{ env.PATH_KEY }}
        shell: bash
      - name: Verify connection to static-reporting server
        id: verify-conn
        run: |
          cat ${{ env.PATH_KEY }}
          ssh -v -i ${{ env.PATH_KEY }} ${{ env.SSH_OPTS }} ${{ env.STATICREPORTING_USER }}@${{ env.STATICREPORTING_SERVER }}
          if [ $? == 0 ]; then
            echo "::set-output name=run_job_next::yes"
          fi
        shell: bash
    outputs:
      run_job_next: ${{ steps.verify-conn.outputs.run_job_next }}
  
  fmos-ssh-scp-pipeline-test:
    name: Test ssh scp pipeline
    needs:
      - fmos-ssh-scp-pipeline-test-connection
    if: false && needs.fmos-ssh-scp-pipeline-test-connection.outputs.run_job_next == 'yes'
    runs-on: fmos-guest-ubuntu-24c
    container:
      image: amr-registry.caas.intel.com/zephyrproject/ci-sdk:v0.26.4.5
      options: "-v /srv/runner/workspace:/runner/workspace"
    env:
      STATICREPORTING_USER: 'zephyr'
      STATICREPORTING_SERVER: 'zep-fmos-static-reporting.igk.intel.com'
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        scp-src: [ '', 'test_ssh_scp/twister.json,test_ssh_scp/twister.log' ]
        scp-dst: [ '', '/home/zephyr/test_ssh_scp/' ]
        ssh-pre: [ '', 'mkdir ~/test_ssh_scp' ]
        ssh-post: [ '', 'mv ~/test_ssh_scp ~/test-ssh-post' ]
        ssh-pre-rollback: [ '', 'rm -rf ~/test-ssh-post' ]
        scp-rollback: [ false, true ]
    steps:
      - name: Clean
        run: rm -rf test_ssh_scp
      - name: Environment Setup
        if: success()
        run: |
          mkdir test_ssh_scp
          cd test_ssh_scp
          touch twister.log
          touch twister.json
          touch twister.xml
      - name: ssh scp pipeline test
        id: ssh-scp-pipeline-test
        uses: intel-innersource/os.rtos.zephyr.devops.ci/actions/fmos-scp-ssh-pipeline@awilczax/fix-fmos-ssh-scp-pipeline-test
        if: success()
        with:
          hostname: "$STATICREPORTING_SERVER"
          ssh-user: "$STATICREPORTING_USER"
          ssh-key: "$IGK_PRIVATE_KEY"
        continue-on-error: true
      - name: Clean
        if: success()
        run: rm -rf test_ssh_scp
