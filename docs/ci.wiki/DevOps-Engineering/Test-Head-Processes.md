# Zephyr DevOps Test-Head Operations

## **Links:**
### **[zephyr-testhead.git](https://gitlab.devtools.intel.com/zephyrproject-rtos/devops/infrastructure/zephyr-testhead)**

## Frequently Asked Questions
### What services does the Test-head provide
* iPXE boot server for all downstream test-agents connected to the Test-net
* dnsmasq providing DHCP/BOOTP + tftp services
* apache2 providing http services for rapid kernel + rootfs transfer
* kernel: intel-lts-linux, latest release, controlled defconfig
* initramfs: ubuntu-base-latest (20.04 currently) + zephyr build depend
			
### How does Jenkins communicate & authenticate with the test-agents?
All Jenkins-Agent communication occurs via Jenkins Remoting, over ssh. Authentication is via a single SSH key that is generated by the pxeboot service when it is installed on the Testhead.

### If the agents are confined to the private test net, how does Jenkins connect to the agents?
The Testhead implements an ssh port-forward through the test firewall, one port for each agent. For example:
	external port 22220 -> private 192.168.0.220:22
	external port 22221 -> private 192.168.0.221:22
	...

### Can I login to the agents directly?
Yes, this is an expected tasks for DevOps & QA engineers for debugging. You will need the SSH key for root@<test-agent> from the test-head, located at <TODO: decide std path>. To login:
    ssh -i <path-to-key> root@<test-agent.ip.address>

### Where are my build files on the test-agent?
Jenkins remoting uses a $JENKINS_HOME/$WORKSPACE/$JOB_NAME convention for all jobs on the test-agents. Currently $JENKINS_HOME is /jenkins for all Zephyr DevOps test & build agents

### How often do the test-agents power-on or reboot?
It depends- the test-agents are designed to be powered-off when they're not used & powered-on before a job so that DUTs are tested in a freshly power-on state. 

Note: As of WW08'2021, we do not force agents to power-down after a job so that job state is maintained for debugging purposes.

### How do agents register with the Jenkins master
Currently, we do this manually, entering the port #, agent name & labels manually. This operation is only required when a new agent is added or it's DUT inventory is changed.

DevOps is developing an automated process that uses an ansible inventory file to specify the agent-to-DUT mapping using a simple array of DUT types, ETA Z03'2020.

### How is DUTs inventory mapped to agents?
We use Jenkins agent labels to indicate which DUTs are connected to a specific test-agent. Jenkins allows mulitiple labels per agent, for example:
    nuc_64gb-jf			# label for a generic NUC in jf (Jones Farm) with 64GB of RAM suitable for virtual sanitycheck jobgs
    hwtest-jf-frdm_k64f # label for a hwtest agent in JF with a frdm_k64f zephyr DUT attached.

Each test-agent is listed by IP address in an ansible inventory file that also specifies an array of Zephyr-project DUTs that are attached. When the ansible playbook is run at agent boot, this array is read and automatically.
